# Feature 0002: Client Frontend Application

## Brief Description

Build a secure, user-friendly web application that allows clients to connect their MT5 accounts and run the scalping bot with real-time monitoring and control. The application provides institutional-grade scalping technology without requiring users to write code or understand technical details. Users can sign up, configure MT5 credentials (encrypted storage), set bot risk settings and trading sessions, monitor live trading activity, view performance analytics, and control bot operations (pause/resume, force close positions, reset circuit breakers).

## Files and Functions to Create

### Database Schema (PostgreSQL)

#### `server/src/schema/mt5_accounts.ts`
- `mt5_accounts` table:
  - `id`: UUID primary key
  - `user_id`: Foreign key to `users.id`
  - `account_number`: Encrypted text (account number)
  - `password`: Encrypted text (MT5 password)
  - `server`: Text (broker server name)
  - `broker_name`: Text (pre-configured broker name)
  - `is_active`: Boolean (currently active account)
  - `connection_status`: Enum ('connected', 'disconnected', 'error', 'paused')
  - `last_connection_test`: Timestamp
  - `created_at`: Timestamp
  - `updated_at`: Timestamp
- `encrypt_credentials()`: Function to encrypt account_number and password before storage
- `decrypt_credentials()`: Function to decrypt credentials for MT5 connection (server-side only)

#### `server/src/schema/bot_configs.ts`
- `bot_configs` table:
  - `id`: UUID primary key
  - `user_id`: Foreign key to `users.id`
  - `mt5_account_id`: Foreign key to `mt5_accounts.id`
  - `risk_percent`: Decimal (0.5% default)
  - `stop_loss_range`: JSONB `{min: 0.25, max: 0.40, preferred: 0.30}`
  - `risk_reward_ratio`: Decimal (1.2 default)
  - `trading_sessions`: JSONB array of enabled sessions `[{start: "08:00", end: "09:30", type: "prime"}, ...]`
  - `is_trading_active`: Boolean (paused/resumed state)
  - `created_at`: Timestamp
  - `updated_at`: Timestamp

#### `server/src/schema/trading_activity.ts`
- `trading_signals` table:
  - `id`: UUID primary key
  - `user_id`: Foreign key to `users.id`
  - `mt5_account_id`: Foreign key to `mt5_accounts.id`
  - `signal_type`: Enum ('BUY', 'SELL', 'HOLD')
  - `confidence`: Decimal (0-100)
  - `timestamp`: Timestamp
  - `price`: Decimal
  - `reason`: Text
  - `became_trade`: Boolean (whether signal was executed)
  - `rejection_reason`: Text (if not executed)
- `trades` table:
  - `id`: UUID primary key
  - `user_id`: Foreign key to `users.id`
  - `mt5_account_id`: Foreign key to `mt5_accounts.id`
  - `ticket`: Integer (MT5 ticket number)
  - `direction`: Enum ('BUY', 'SELL')
  - `entry_price`: Decimal
  - `exit_price`: Decimal (nullable)
  - `lot_size`: Decimal
  - `stop_loss`: Decimal
  - `take_profit`: Decimal
  - `entry_time`: Timestamp
  - `exit_time`: Timestamp (nullable)
  - `pnl`: Decimal (nullable)
  - `hold_time_seconds`: Integer (nullable)
  - `exit_reason`: Text (nullable: 'take_profit', 'stop_loss', 'time_limit', 'momentum_reversal', 'force_close')
  - `partial_exits`: JSONB array `[{percent: 50, price: 2050.25, time: timestamp}, ...]`
- `circuit_breaker_events` table:
  - `id`: UUID primary key
  - `user_id`: Foreign key to `users.id`
  - `mt5_account_id`: Foreign key to `mt5_accounts.id`
  - `event_type`: Enum ('halt', 'reset', 'risk_adjustment')
  - `reason`: Text
  - `halted_until`: Timestamp (nullable)
  - `timestamp`: Timestamp

#### `server/src/schema/account_settings.ts`
- `account_settings` table:
  - `id`: UUID primary key
  - `user_id`: Foreign key to `users.id` (unique)
  - `timezone`: Text (IANA timezone string, default: 'UTC')
  - `email_notifications`: Boolean
  - `notification_preferences`: JSONB `{trade_executions: true, circuit_breaker: true, daily_summary: true}`
  - `updated_at`: Timestamp

### Backend API Endpoints

#### `server/src/api.ts` - Add new route groups

#### `server/src/routes/mt5.ts`
- `POST /api/v1/protected/mt5/accounts`: Create new MT5 account connection
  - Request body: `{account_number: string, password: string, server: string, broker_name?: string}`
  - Encrypts credentials before storage
  - Returns: `{id: string, server: string, broker_name: string, connection_status: string}`
- `GET /api/v1/protected/mt5/accounts`: List all user's MT5 accounts
  - Returns: Array of accounts (without decrypted credentials)
- `GET /api/v1/protected/mt5/accounts/:id`: Get specific account details
- `POST /api/v1/protected/mt5/accounts/:id/test`: Test MT5 connection
  - Decrypts credentials, attempts MT5 connection
  - Updates `last_connection_test` and `connection_status`
  - Returns: `{connected: boolean, error?: string, account_info?: {equity: number, balance: number}}`
- `PUT /api/v1/protected/mt5/accounts/:id`: Update account (server, broker_name only)
- `DELETE /api/v1/protected/mt5/accounts/:id`: Delete account (soft delete or hard delete)
- `POST /api/v1/protected/mt5/accounts/:id/activate`: Set account as active (deactivates others)

#### `server/src/routes/bot-config.ts`
- `POST /api/v1/protected/bot-config`: Create bot configuration
  - Request body: `{mt5_account_id: string, risk_percent: number, stop_loss_range: object, risk_reward_ratio: number, trading_sessions: array}`
- `GET /api/v1/protected/bot-config/:mt5_account_id`: Get configuration for account
- `PUT /api/v1/protected/bot-config/:id`: Update configuration
- `POST /api/v1/protected/bot-config/:id/toggle-trading`: Toggle `is_trading_active` (pause/resume)
  - Returns: `{is_trading_active: boolean}`

#### `server/src/routes/trading-activity.ts`
- `GET /api/v1/protected/trading/signals`: Get recent signals
  - Query params: `limit`, `offset`, `mt5_account_id?`, `signal_type?`, `date_from?`, `date_to?`
  - Returns: Array of signals with pagination metadata
- `GET /api/v1/protected/trading/trades`: Get trade history
  - Query params: `limit`, `offset`, `mt5_account_id?`, `direction?`, `date_from?`, `date_to?`, `outcome?` (win/loss)
  - Returns: Array of trades with pagination
- `GET /api/v1/protected/trading/trades/:id`: Get single trade details with chart replay data
- `GET /api/v1/protected/trading/circuit-breaker-events`: Get circuit breaker history
- `GET /api/v1/protected/trading/export-trades`: Export trades to CSV
  - Query params: `mt5_account_id?`, `date_from?`, `date_to?`
  - Returns: CSV file download

#### `server/src/routes/dashboard.ts`
- `GET /api/v1/protected/dashboard/status`: Get real-time dashboard status
  - Returns: `{equity: number, daily_pnl: {amount: number, percent: number}, open_position: {...}, bot_status: string, today_stats: {trades: number, win_rate: number, avg_hold_time: number}, connection_status: string}`
- `GET /api/v1/protected/dashboard/activity-feed`: Get live activity feed
  - Query params: `limit`, `since?` (timestamp for incremental updates)
  - Returns: Array of activity events (signals, trades, circuit breaker events) sorted by timestamp
- `POST /api/v1/protected/dashboard/force-close-position`: Force close open position
  - Request body: `{mt5_account_id: string}`
  - Returns: `{success: boolean, error?: string}`
- `POST /api/v1/protected/dashboard/reset-circuit-breaker`: Reset circuit breaker
  - Request body: `{mt5_account_id: string}`
  - Returns: `{success: boolean}`

#### `server/src/routes/analytics.ts`
- `GET /api/v1/protected/analytics/performance-metrics`: Get performance metrics
  - Query params: `mt5_account_id?`, `date_from?`, `date_to?`
  - Returns: `{total_trades, win_rate, profit_factor, avg_win, avg_loss, largest_win, largest_loss, avg_hold_time, max_hold_time, sharpe_ratio, max_drawdown, best_day, worst_day}`
- `GET /api/v1/protected/analytics/time-analysis`: Get time-based analysis
  - Query params: `mt5_account_id?`, `period?` (day/week/month)
  - Returns: `{by_hour: [{hour: 0-23, trades: number, win_rate: number, pnl: number}, ...], by_day_of_week: [...], by_session: [{session: string, trades: number, win_rate: number, pnl: number}, ...]}`
- `GET /api/v1/protected/analytics/signal-analysis`: Get signal analysis
  - Query params: `mt5_account_id?`, `date_from?`, `date_to?`
  - Returns: `{total_signals, approval_rate, rejection_reasons: [{reason: string, count: number}, ...], confidence_vs_outcome: [{confidence_range: string, win_rate: number}, ...]}`

#### `server/src/routes/account-settings.ts`
- `GET /api/v1/protected/account-settings`: Get user account settings
- `PUT /api/v1/protected/account-settings`: Update settings
  - Request body: `{timezone?: string, email_notifications?: boolean, notification_preferences?: object}`
- `PUT /api/v1/protected/account-settings/password`: Change password
  - Request body: `{current_password: string, new_password: string}`
  - Uses Firebase Admin SDK to update password

#### `server/src/lib/encryption.ts`
- `encrypt(text: string, key: string): string`: Encrypt sensitive data using AES-256-GCM
  - Uses environment variable `ENCRYPTION_KEY` (32-byte key)
  - Returns base64-encoded encrypted string with IV and auth tag
- `decrypt(encrypted: string, key: string): string`: Decrypt data
  - Validates authentication tag before decryption
- `generateEncryptionKey(): string`: Generate new encryption key (for initial setup)

#### `server/src/lib/mt5-connector.ts`
- `testMT5Connection(account_number: string, password: string, server: string): Promise<{connected: boolean, account_info?: object, error?: string}>`
  - Connects to MT5 using MetaTrader5 Python library via subprocess or REST API
  - Returns connection status and account equity/balance
  - Handles connection timeouts (5 second limit)

### Frontend Components

#### `ui/src/pages/Onboarding.tsx`
- Multi-step wizard component:
  - Step 1: Email/password signup (uses existing `LoginForm` component)
  - Step 2: Email verification check (polling or Firebase auth state listener)
  - Step 3: MT5 credentials setup (`MT5ConnectionWizard` component)
  - Step 4: Bot configuration (`BotConfigWizard` component)
  - Step 5: Connection test and start trading confirmation
- Navigation: Next/Back buttons, progress indicator
- State management: React state for form data across steps

#### `ui/src/components/mt5/MT5ConnectionWizard.tsx`
- Form fields:
  - Account number input (masked display)
  - Password input (masked)
  - Server input (text field)
  - Broker selection dropdown (pre-configured brokers: IC Markets, Pepperstone, FXTM, etc.)
  - "Test Connection" button (calls test endpoint, shows loading/success/error)
- Validation: Required fields, server format validation
- Multiple account support: "Add Another Account" button, account list display

#### `ui/src/components/mt5/ConnectionStatusIndicator.tsx`
- Visual indicator component:
  - Green dot + "Connected and Trading" (connection_status: 'connected', is_trading_active: true)
  - Yellow dot + "Connected but Paused" (connection_status: 'connected', is_trading_active: false)
  - Yellow dot + "Outside Trading Hours" (connection_status: 'connected', session check)
  - Red dot + "Disconnected" (connection_status: 'disconnected')
  - Red dot + "Error" (connection_status: 'error')
- Real-time updates via polling or WebSocket (if implemented)

#### `ui/src/pages/Dashboard.tsx`
- Main dashboard layout:
  - Top section: Key metrics cards (4-5 cards in grid)
  - Middle section: Live activity feed (scrollable list)
  - Bottom section: Quick actions (buttons) + Charts (tabs: equity curve, win rate heatmap, P&L distribution, trade duration)
- Real-time data: Polling every 5-10 seconds for status and activity feed
- Responsive grid layout (Tailwind grid)

#### `ui/src/components/dashboard/MetricCard.tsx`
- Reusable card component for metrics
- Props: `title: string, value: string | number, change?: {amount: number, percent: number, isPositive: boolean}, icon?: ReactNode`
- Displays value, optional change indicator (green/red), icon

#### `ui/src/components/dashboard/ActivityFeed.tsx`
- Real-time activity log component
- Event types:
  - Signal: `"BUY signal (85% confidence) at $2050.25"`
  - Trade execution: `"Trade opened: BUY 0.10 lots at $2050.25"`
  - Position update: `"Stop loss moved to breakeven"`
  - Circuit breaker: `"Circuit breaker activated: 3 consecutive losses"`
  - Session change: `"Entering prime trading session (08:00 GMT)"`
- Auto-scroll to bottom on new events
- Timestamp display (relative: "2s ago", absolute on hover)
- Color coding: Green (positive), Red (negative), Blue (info), Yellow (warning)

#### `ui/src/components/dashboard/QuickActions.tsx`
- Action buttons:
  - "Pause Trading" / "Resume Trading" (big toggle, primary color)
  - "Force Close Position" (secondary, disabled if no open position)
  - "Reset Circuit Breaker" (secondary, disabled if not halted)
  - "Adjust Risk Settings" (opens modal)
- Confirmation dialogs for destructive actions (force close, reset)

#### `ui/src/components/dashboard/EquityCurveChart.tsx`
- Chart component using Recharts or Chart.js
- Props: `data: Array<{timestamp: string, equity: number}>, period: 'today' | 'week' | 'month' | 'all-time'`
- Line chart showing equity over time
- Period selector: Tabs or dropdown

#### `ui/src/components/dashboard/WinRateHeatmap.tsx`
- Heatmap visualization (24 hours x 7 days or hour-of-day only)
- Color intensity based on win rate (green = high, red = low)
- Tooltip on hover: hour, trades count, win rate, P&L

#### `ui/src/pages/Analytics.tsx`
- Analytics page with tabs:
  - Tab 1: Performance Metrics (cards + table)
  - Tab 2: Time-Based Analysis (tables + heatmaps)
  - Tab 3: Trade History (sortable/filterable table)
  - Tab 4: Signal Analysis (charts + breakdowns)
- Date range picker (ShadCN DatePicker component)
- Account selector (if multiple accounts)
- Export buttons (CSV download)

#### `ui/src/components/analytics/TradeHistoryTable.tsx`
- Sortable table (ShadCN Table component)
- Columns: Date, Direction, Entry, Exit, P&L, Hold Time, Exit Reason
- Filters: Date range (DatePicker), Direction (dropdown), Outcome (win/loss dropdown)
- Row click: Opens detailed trade view modal
- Pagination: Client-side or server-side (based on data size)

#### `ui/src/components/analytics/TradeDetailModal.tsx`
- Modal component (ShadCN Dialog)
- Displays: Full trade details, chart replay (candlestick chart showing entry/exit points), partial exit history
- Chart: Uses tradingview-lightweight-charts or similar library

#### `ui/src/pages/AccountSettings.tsx`
- Settings page (extends existing `Settings.tsx`):
  - Profile section: Name, email, timezone selector (timezone-select library)
  - MT5 Accounts section: List of accounts, edit/delete/test buttons, add new account
  - Password change section: Current password, new password, confirm password
  - Notification preferences: Toggle switches for email notifications
- Save buttons per section

#### `ui/src/pages/Support.tsx`
- Support center page:
  - Live chat widget (iframe or embedded chat service, business hours only)
  - Email support: Contact form or mailto link
  - Troubleshooting guides: Accordion component with common issues
  - Community forum link (optional, external)

### Frontend Utilities and Hooks

#### `ui/src/lib/api/mt5.ts`
- `createMT5Account(data): Promise<MT5Account>`
- `getMT5Accounts(): Promise<MT5Account[]>`
- `testMT5Connection(accountId): Promise<ConnectionTestResult>`
- `updateMT5Account(accountId, data): Promise<MT5Account>`
- `deleteMT5Account(accountId): Promise<void>`
- `activateMT5Account(accountId): Promise<void>`

#### `ui/src/lib/api/bot-config.ts`
- `createBotConfig(data): Promise<BotConfig>`
- `getBotConfig(accountId): Promise<BotConfig>`
- `updateBotConfig(configId, data): Promise<BotConfig>`
- `toggleTrading(configId): Promise<{is_trading_active: boolean}>`

#### `ui/src/lib/api/trading.ts`
- `getSignals(params): Promise<{signals: Signal[], pagination: object}>`
- `getTrades(params): Promise<{trades: Trade[], pagination: object}>`
- `getTradeDetails(tradeId): Promise<Trade>`
- `exportTrades(params): Promise<Blob>` (CSV download)
- `getCircuitBreakerEvents(params): Promise<CircuitBreakerEvent[]>`

#### `ui/src/lib/api/dashboard.ts`
- `getDashboardStatus(): Promise<DashboardStatus>`
- `getActivityFeed(params): Promise<ActivityEvent[]>`
- `forceClosePosition(accountId): Promise<void>`
- `resetCircuitBreaker(accountId): Promise<void>`

#### `ui/src/lib/api/analytics.ts`
- `getPerformanceMetrics(params): Promise<PerformanceMetrics>`
- `getTimeAnalysis(params): Promise<TimeAnalysis>`
- `getSignalAnalysis(params): Promise<SignalAnalysis>`

#### `ui/src/lib/api/account-settings.ts`
- `getAccountSettings(): Promise<AccountSettings>`
- `updateAccountSettings(data): Promise<AccountSettings>`
- `changePassword(data): Promise<void>`

#### `ui/src/hooks/useRealtimeDashboard.ts`
- Custom hook for real-time dashboard data
- Polling logic: `useEffect` with `setInterval` (5-10 second intervals)
- Returns: `{status, activityFeed, isLoading, error, refetch}`
- Cleans up interval on unmount

#### `ui/src/hooks/useMT5Connection.ts`
- Custom hook for MT5 connection management
- Functions: `testConnection`, `createAccount`, `updateAccount`, `deleteAccount`
- Returns: `{accounts, isLoading, error, testConnection, createAccount, ...}`

#### `ui/src/types/trading.ts`
- TypeScript type definitions:
  - `MT5Account`, `BotConfig`, `Signal`, `Trade`, `CircuitBreakerEvent`
  - `DashboardStatus`, `ActivityEvent`, `PerformanceMetrics`, `TimeAnalysis`, `SignalAnalysis`
  - `ConnectionTestResult`, `TradingSession`

### Frontend Routing

#### `ui/src/App.tsx` - Update routes
- Add routes:
  - `/onboarding`: Onboarding wizard (redirect if already onboarded)
  - `/dashboard`: Main dashboard (default authenticated route)
  - `/analytics`: Analytics page
  - `/account-settings`: Account settings (existing `/settings` route)
  - `/support`: Support center
- Protected routes: All routes except login require authentication
- Onboarding check: Redirect to `/onboarding` if user has no MT5 accounts

## Algorithms Explained

### Onboarding Flow Algorithm

**Step 1: Email/Password Signup**
1. User enters email and password in `LoginForm` component
2. Firebase Auth `createUserWithEmailAndPassword()` creates account
3. Firebase sends verification email automatically
4. Frontend shows "Check your email" message

**Step 2: Email Verification Check**
1. Poll Firebase Auth `user.emailVerified` property every 2 seconds
2. Alternative: Listen to `onAuthStateChanged` for email verification updates
3. When verified, enable "Next" button to proceed to Step 3
4. Store verification status in component state

**Step 3: MT5 Credentials Setup**
1. User enters account number, password, server, selects broker
2. On "Test Connection" click:
   - Call `POST /api/v1/protected/mt5/accounts/:id/test` (if updating) or create account first then test
   - Backend decrypts credentials, calls MT5 connector
   - Returns `{connected: boolean, account_info: {equity, balance}, error?: string}`
3. On success: Show success message, enable "Next" button
4. On error: Display error message, allow retry
5. Store account ID in onboarding state

**Step 4: Bot Configuration Wizard**
1. Display form fields:
   - Risk percent: Slider or input (0.1% - 2.0%, default 0.5%)
   - Stop loss range: Min/Max/Preferred inputs (default: 0.25/0.40/0.30)
   - Risk-reward ratio: Input (default 1.2)
   - Trading sessions: Multi-select checkboxes with time ranges:
     - Prime: 08:00-09:30, 13:00-15:00, 14:30-15:30 GMT
     - Acceptable: 09:30-13:00, 15:30-17:00 GMT
2. Validate: Risk percent > 0, stop loss min < max, R:R >= 1.0, at least one session selected
3. On submit: Call `POST /api/v1/protected/bot-config` with MT5 account ID
4. Store config ID in onboarding state

**Step 5: Connection Test and Start Trading**
1. Display summary: Account info, config settings
2. "Test Connection" button: Re-test MT5 connection
3. "Start Trading" button:
   - Call `POST /api/v1/protected/bot-config/:id/toggle-trading` to set `is_trading_active: true`
   - Redirect to `/dashboard`
4. Mark onboarding as complete (store in user profile or check for existing bot config)

### Real-Time Dashboard Data Polling Algorithm

**Polling Strategy:**
1. On component mount (`useRealtimeDashboard` hook):
   - Initial fetch: `GET /api/v1/protected/dashboard/status` and `GET /api/v1/protected/dashboard/activity-feed`
   - Set up interval: `setInterval(() => fetchData(), 5000)` (5 seconds)
2. For activity feed incremental updates:
   - Store `lastEventTimestamp` from previous fetch
   - Subsequent calls: `GET /api/v1/protected/dashboard/activity-feed?since=<timestamp>`
   - Backend filters events after timestamp
   - Append new events to existing feed (prevent duplicates by event ID)
3. On component unmount: Clear interval with `clearInterval`
4. Error handling: On fetch error, retry with exponential backoff (1s, 2s, 4s, max 30s)

**Data Transformation:**
- Status data: Direct mapping to metric cards
- Activity feed: Transform events to display format:
  - Signal: `"${signal_type} signal (${confidence}% confidence) at $${price}"`
  - Trade: `"Trade ${action}: ${direction} ${lot_size} lots at $${price}"`
  - Circuit breaker: `"Circuit breaker ${event_type}: ${reason}"`
- Timestamps: Convert to relative time ("2s ago") using `date-fns` or similar

### MT5 Connection Test Algorithm

**Backend (`testMT5Connection` function):**
1. Decrypt account credentials using `decrypt()` function with `ENCRYPTION_KEY`
2. Initialize MT5 connection:
   - Import MetaTrader5 library (Python subprocess or Node.js wrapper)
   - Call `MT5.initialize()` with server, login, password
   - Set timeout: 5 seconds
3. If connection succeeds:
   - Call `MT5.account_info()` to get equity, balance, margin
   - Call `MT5.terminal_info()` to verify connection
   - Disconnect: `MT5.shutdown()`
   - Return: `{connected: true, account_info: {equity, balance, margin}}`
4. If connection fails:
   - Catch error, return: `{connected: false, error: error.message}`
5. Update database: Set `connection_status` and `last_connection_test` timestamp

**Frontend:**
1. Show loading state on "Test Connection" button
2. Call `testMT5Connection(accountId)` API function
3. On success: Display green checkmark, account equity/balance, enable "Next"
4. On error: Display red X, error message, allow retry

### Credential Encryption Algorithm

**Encryption (Backend):**
1. Use AES-256-GCM encryption (Node.js `crypto` module)
2. Generate random 12-byte IV for each encryption
3. Use `ENCRYPTION_KEY` environment variable (32-byte key, base64-encoded)
4. Encrypt: `cipher = crypto.createCipheriv('aes-256-gcm', key, iv)`
5. Append authentication tag (16 bytes) to encrypted data
6. Store: Base64-encode `iv + encrypted_data + auth_tag`
7. Format: `base64(iv + encrypted + tag)`

**Decryption (Backend only, never sent to frontend):**
1. Decode base64 string
2. Extract: IV (first 12 bytes), encrypted data (middle), auth tag (last 16 bytes)
3. Decrypt: `decipher = crypto.createDecipheriv('aes-256-gcm', key, iv)`
4. Set auth tag: `decipher.setAuthTag(auth_tag)`
5. Decrypt and return plaintext
6. If authentication fails (tag mismatch), throw error (prevents tampering)

### Activity Feed Incremental Update Algorithm

**Backend (`GET /api/v1/protected/dashboard/activity-feed`):**
1. Parse query parameter `since` (ISO timestamp string)
2. Query database:
   - `SELECT * FROM trading_signals WHERE user_id = ? AND timestamp > ? ORDER BY timestamp DESC LIMIT 50`
   - `SELECT * FROM trades WHERE user_id = ? AND (entry_time > ? OR exit_time > ?) ORDER BY entry_time DESC LIMIT 50`
   - `SELECT * FROM circuit_breaker_events WHERE user_id = ? AND timestamp > ? ORDER BY timestamp DESC LIMIT 20`
3. Merge results, sort by timestamp descending
4. Return: `{events: Array<ActivityEvent>, last_timestamp: string}`

**Frontend:**
1. Store `lastEventTimestamp` in component state (initially `null`)
2. First fetch: `GET /api/v1/protected/dashboard/activity-feed` (no `since` param)
3. Subsequent fetches: `GET /api/v1/protected/dashboard/activity-feed?since=${lastEventTimestamp}`
4. Append new events to existing feed array (prepend, since sorted DESC)
5. Deduplicate by event ID (signal ID, trade ID, event ID)
6. Limit feed to last 100 events (remove oldest if exceeds)

### Performance Metrics Calculation Algorithm

**Backend (`GET /api/v1/protected/analytics/performance-metrics`):**
1. Query trades: `SELECT * FROM trades WHERE user_id = ? AND exit_time IS NOT NULL [AND date filters]`
2. Calculate metrics:
   - `total_trades`: COUNT(*)
   - `win_rate`: COUNT(CASE WHEN pnl > 0 THEN 1 END) / COUNT(*) * 100
   - `profit_factor`: SUM(CASE WHEN pnl > 0 THEN pnl ELSE 0 END) / ABS(SUM(CASE WHEN pnl < 0 THEN pnl ELSE 0 END))
   - `avg_win`: AVG(CASE WHEN pnl > 0 THEN pnl END)
   - `avg_loss`: AVG(CASE WHEN pnl < 0 THEN pnl END)
   - `largest_win`: MAX(pnl)
   - `largest_loss`: MIN(pnl)
   - `avg_hold_time`: AVG(hold_time_seconds)
   - `max_hold_time`: MAX(hold_time_seconds)
3. Calculate Sharpe ratio (if sufficient data):
   - Daily returns: Group trades by date, sum P&L per day
   - Mean return: AVG(daily_returns)
   - Std deviation: STDDEV(daily_returns)
   - Sharpe = (mean_return / std_deviation) * sqrt(252) (annualized)
4. Calculate max drawdown:
   - Equity curve: Cumulative sum of P&L over time
   - Peak equity: Track running maximum
   - Drawdown: (peak_equity - current_equity) / peak_equity
   - Max drawdown: MAX(drawdown)
5. Best/worst day: Group by date, find date with max/min P&L
6. Return JSON object with all metrics

### Time-Based Analysis Algorithm

**By Hour of Day:**
1. Query trades: `SELECT *, EXTRACT(HOUR FROM entry_time AT TIME ZONE 'UTC') as hour FROM trades WHERE ...`
2. Group by hour (0-23)
3. For each hour: Calculate trades count, wins count, total P&L
4. Win rate: `wins / trades * 100`
5. Return: `[{hour: 0, trades: 5, wins: 3, win_rate: 60, pnl: 125.50}, ...]`

**By Day of Week:**
1. Query: `SELECT *, EXTRACT(DOW FROM entry_time AT TIME ZONE 'UTC') as day_of_week FROM trades WHERE ...`
2. Group by day (0=Sunday, 6=Saturday)
3. Calculate same metrics per day
4. Return: `[{day: 'Monday', trades: 20, win_rate: 65, pnl: 500}, ...]`

**By Session:**
1. Define session time ranges (GMT):
   - London Open: 08:00-09:30
   - London-NY Overlap: 13:00-15:00
   - NY Data Releases: 14:30-15:30
   - London Morning: 09:30-13:00
   - NY Afternoon: 15:30-17:00
2. Query trades, extract hour from `entry_time`
3. Classify each trade into session based on hour
4. Group by session, calculate metrics
5. Return: `[{session: 'London-NY Overlap', trades: 45, win_rate: 70, pnl: 1200}, ...]`

### Signal Analysis Algorithm

**Approval Rate:**
1. Query signals: `SELECT COUNT(*) as total, COUNT(CASE WHEN became_trade = true THEN 1 END) as approved FROM trading_signals WHERE ...`
2. Approval rate: `approved / total * 100`

**Rejection Reasons:**
1. Query: `SELECT rejection_reason, COUNT(*) as count FROM trading_signals WHERE became_trade = false AND rejection_reason IS NOT NULL GROUP BY rejection_reason`
2. Return: `[{reason: 'spread_too_wide', count: 15}, {reason: 'atr_out_of_range', count: 8}, ...]`

**Confidence vs Outcome:**
1. Join signals with trades: `SELECT s.confidence, t.pnl FROM trading_signals s JOIN trades t ON s.id = t.signal_id WHERE t.exit_time IS NOT NULL`
2. Group confidence into ranges: 0-50, 50-60, 60-70, 70-80, 80-90, 90-100
3. For each range: Calculate win rate (trades with pnl > 0)
4. Return: `[{confidence_range: '70-80', win_rate: 68, trades: 25}, ...]`

## Implementation Phases

### Phase 1: Data Layer and Database Schema
**Purpose:** Establish database schema, encryption utilities, and core data structures.

**Tasks:**
1. Create `server/src/schema/mt5_accounts.ts` with table definition and encryption functions
2. Create `server/src/schema/bot_configs.ts` with table definition
3. Create `server/src/schema/trading_activity.ts` with signals, trades, and circuit_breaker_events tables
4. Create `server/src/schema/account_settings.ts` with table definition
5. Create `server/src/lib/encryption.ts` with encrypt/decrypt functions
6. Create database migration files using Drizzle (run `pnpm drizzle-kit generate`)
7. Update `server/src/schema/users.ts` if needed (add timezone, notification preferences)
8. Test encryption/decryption functions

**Deliverables:**
- All database tables defined
- Encryption utilities working
- Migration files generated

### Phase 2A: Backend API - MT5 and Bot Config
**Purpose:** Implement MT5 account management and bot configuration endpoints.

**Tasks:**
1. Create `server/src/lib/mt5-connector.ts` with connection test function
2. Create `server/src/routes/mt5.ts` with all MT5 account endpoints
3. Create `server/src/routes/bot-config.ts` with configuration endpoints
4. Integrate routes into `server/src/api.ts`
5. Test endpoints with Postman or similar

**Dependencies:** Phase 1

**Deliverables:**
- MT5 account CRUD endpoints
- Bot configuration endpoints
- Connection testing functionality

### Phase 2B: Backend API - Trading Activity and Dashboard
**Purpose:** Implement trading activity endpoints and real-time dashboard data.

**Tasks:**
1. Create `server/src/routes/trading-activity.ts` with signals, trades, circuit breaker endpoints
2. Create `server/src/routes/dashboard.ts` with status and activity feed endpoints
3. Implement incremental activity feed query logic
4. Add CSV export functionality for trades
5. Integrate routes into `server/src/api.ts`

**Dependencies:** Phase 1

**Deliverables:**
- Trading activity endpoints
- Dashboard status and activity feed
- CSV export functionality

### Phase 2C: Backend API - Analytics
**Purpose:** Implement analytics and performance calculation endpoints.

**Tasks:**
1. Create `server/src/routes/analytics.ts` with performance metrics, time analysis, signal analysis endpoints
2. Implement performance metrics calculation (win rate, profit factor, Sharpe ratio, max drawdown)
3. Implement time-based analysis queries (by hour, day, session)
4. Implement signal analysis queries (approval rate, rejection reasons, confidence correlation)
5. Integrate routes into `server/src/api.ts`

**Dependencies:** Phase 1

**Deliverables:**
- Analytics endpoints with all calculations
- Time-based analysis queries
- Signal analysis queries

### Phase 2D: Backend API - Account Settings
**Purpose:** Implement account settings and password change endpoints.

**Tasks:**
1. Create `server/src/routes/account-settings.ts` with settings endpoints
2. Implement password change using Firebase Admin SDK
3. Integrate routes into `server/src/api.ts`

**Dependencies:** Phase 1

**Deliverables:**
- Account settings endpoints
- Password change functionality

### Phase 3A: Frontend - Onboarding Flow
**Purpose:** Build user onboarding wizard with MT5 setup and bot configuration.

**Tasks:**
1. Create `ui/src/pages/Onboarding.tsx` with multi-step wizard
2. Create `ui/src/components/mt5/MT5ConnectionWizard.tsx` component
3. Create `ui/src/components/mt5/ConnectionStatusIndicator.tsx` component
4. Create `ui/src/lib/api/mt5.ts` and `ui/src/lib/api/bot-config.ts` API functions
5. Create `ui/src/hooks/useMT5Connection.ts` hook
6. Update `ui/src/App.tsx` routing to include onboarding
7. Add onboarding completion check (redirect logic)

**Dependencies:** Phase 2A

**Deliverables:**
- Complete onboarding flow
- MT5 connection wizard
- Bot configuration wizard

### Phase 3B: Frontend - Dashboard
**Purpose:** Build main dashboard with real-time monitoring and controls.

**Tasks:**
1. Create `ui/src/pages/Dashboard.tsx` with layout
2. Create `ui/src/components/dashboard/MetricCard.tsx` component
3. Create `ui/src/components/dashboard/ActivityFeed.tsx` component
4. Create `ui/src/components/dashboard/QuickActions.tsx` component
5. Create `ui/src/components/dashboard/EquityCurveChart.tsx` component (using Recharts)
6. Create `ui/src/components/dashboard/WinRateHeatmap.tsx` component
7. Create `ui/src/lib/api/dashboard.ts` and `ui/src/lib/api/trading.ts` API functions
8. Create `ui/src/hooks/useRealtimeDashboard.ts` hook
9. Create `ui/src/types/trading.ts` type definitions
10. Update `ui/src/App.tsx` routing

**Dependencies:** Phase 2B

**Deliverables:**
- Complete dashboard page
- Real-time data polling
- Activity feed
- Quick actions

### Phase 3C: Frontend - Analytics
**Purpose:** Build analytics page with performance metrics and trade history.

**Tasks:**
1. Create `ui/src/pages/Analytics.tsx` with tabs
2. Create `ui/src/components/analytics/TradeHistoryTable.tsx` component
3. Create `ui/src/components/analytics/TradeDetailModal.tsx` component
4. Create chart components for time analysis (heatmaps, bar charts)
5. Create `ui/src/lib/api/analytics.ts` API functions
6. Implement CSV export functionality
7. Add date range picker and filters

**Dependencies:** Phase 2C

**Deliverables:**
- Analytics page with all tabs
- Trade history table with filters
- Performance metrics display
- Chart visualizations

### Phase 3D: Frontend - Account Settings and Support
**Purpose:** Build account settings page and support center.

**Tasks:**
1. Update `ui/src/pages/Settings.tsx` (rename to `AccountSettings.tsx` or extend)
2. Add MT5 accounts management section
3. Add password change functionality
4. Add timezone selector and notification preferences
5. Create `ui/src/pages/Support.tsx` with troubleshooting guides
6. Create `ui/src/lib/api/account-settings.ts` API functions
7. Update routing

**Dependencies:** Phase 2D

**Deliverables:**
- Account settings page
- Support center page

## Configuration Requirements

### Environment Variables (Backend `.env`)
- `ENCRYPTION_KEY`: 32-byte base64-encoded key for credential encryption (generate with `generateEncryptionKey()`)
- `MT5_PYTHON_PATH`: Path to Python executable with MetaTrader5 library (optional, for MT5 connection testing)
- `MT5_API_URL`: URL to MT5 REST API service (if using REST instead of Python subprocess)

### Environment Variables (Frontend `.env`)
- `VITE_API_URL`: Backend API URL (default: `http://localhost:8787`)

### Database Migrations
- Run `cd server && pnpm drizzle-kit generate` after schema changes
- Run `pnpm drizzle-kit migrate` to apply migrations

## Integration Points

- **Firebase Auth**: User authentication, email verification, password changes
- **PostgreSQL (Supabase)**: All application data storage
- **MetaTrader5 API**: Connection testing (via Python subprocess or REST API)
- **Trading Engine Backend (Feature 0001)**: Real-time trading data (signals, trades, circuit breaker events) - assumes trading engine writes to same database or provides API endpoints
- **ShadCN Components**: UI component library (Card, Button, Input, Table, Dialog, Tabs, etc.)
- **Recharts or Chart.js**: Chart visualizations for analytics

## Notes

- **Credential Security**: MT5 credentials are encrypted at rest using AES-256-GCM. Decryption only happens server-side during connection tests. Never send decrypted credentials to frontend.
- **Real-Time Updates**: Initial implementation uses polling (5-10 second intervals). Future enhancement: WebSocket or Server-Sent Events for true real-time updates.
- **Onboarding Completion**: Check if user has at least one MT5 account and bot config. If not, redirect to `/onboarding`.
- **Multiple Accounts**: Users can have multiple MT5 accounts but only one active at a time. Active account is used for trading and dashboard display.
- **Timezone Handling**: All timestamps stored in UTC. Frontend converts to user's timezone for display using `date-fns-tz` or similar.
- **Chart Libraries**: Use Recharts (React-native) or Chart.js with react-chartjs-2. TradingView Lightweight Charts for trade detail replay.
- **CSV Export**: Generate CSV on backend, return as `Content-Type: text/csv` with `Content-Disposition: attachment` header.

